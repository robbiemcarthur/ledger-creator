name: Deploy to Oracle Cloud

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ${{ secrets.ORACLE_CLOUD_USER }}
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          script_stop: true
          script: |
            set -e  # Exit on any error

            echo "Starting deployment..."

            # Change to deployment directory
            cd /home/ubuntu/creator-ledger || { echo "ERROR: Deployment directory not found!"; exit 1; }

            # Verify required files exist
            [ -f docker-compose.external-db.yml ] || { echo "ERROR: docker-compose.external-db.yml not found!"; exit 1; }
            [ -f .env ] || { echo "ERROR: .env file not found!"; exit 1; }

            echo "Logging in to GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin || { echo "ERROR: Docker login failed!"; exit 1; }

            echo "Pulling latest image..."
            docker compose -f docker-compose.external-db.yml pull app || { echo "ERROR: Failed to pull image!"; exit 1; }

            echo "Deploying application..."
            docker compose -f docker-compose.external-db.yml up -d app || { echo "ERROR: Failed to start container!"; exit 1; }

            echo "Waiting for application to be healthy..."
            RETRY_COUNT=0
            MAX_RETRIES=60
            until docker compose -f docker-compose.external-db.yml exec -T app wget --spider -q http://localhost:8080/actuator/health 2>/dev/null; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                echo "ERROR: Health check failed after $MAX_RETRIES attempts!"
                echo "Container logs:"
                docker logs creator-ledger-app --tail 50
                exit 1
              fi
              echo "Waiting for health check... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 2
            done

            echo "Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deployment successful!"
            docker ps | grep creator-ledger-app
